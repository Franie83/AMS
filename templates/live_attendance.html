{% extends "layout.html" %}
{% block body %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body text-center">
                <h2>üî¥ Live Attendance</h2>
                <p class="text-muted">Look at the camera to automatically sign in/out</p>
                
                <!-- Button to open camera (initially visible) -->
                <div id="startButtonContainer">
                    <button id="startCameraBtn" class="btn btn-primary btn-lg" onclick="startAttendanceCamera()">
                        <i class="fas fa-camera me-2"></i>Take Attendance
                    </button>
                </div>
                
                <!-- Camera section (initially hidden) -->
                <div id="attendanceCameraSection" style="display: none;">
                    <label class="form-label">üì∏ Face Recognition - Look at the camera</label>
                    <div class="camera-container" style="position: relative; width: 100%; height: 350px; background: #000; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                        <video id="attendanceVideo" width="100%" height="100%" autoplay muted playsinline style="object-fit: cover;"></video>
                        <div id="attendanceFaceGuide" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 198px; height: 252px; border: 4px solid rgba(255, 255, 255, 0.9); border-radius: 50% 50% 45% 45% / 55% 55% 45% 45%; box-shadow: 0 0 0 2000px rgba(128, 128, 128, 0.95); pointer-events: none; transition: border-color 0.3s ease; z-index: 10;">
                            <div id="attendanceFaceGuideLabel" style="position: absolute; bottom: -35px; left: 50%; transform: translateX(-50%); color: white; font-size: 14px; white-space: nowrap; text-shadow: 1px 1px 2px black; background: rgba(0,0,0,0.7); padding: 5px 15px; border-radius: 20px; pointer-events: none; z-index: 11;">Look here</div>
                        </div>
                        <!-- Status overlay -->
                        <div id="attendanceStatusOverlay" style="position: absolute; bottom: 20px; left: 20px; right: 20px; background: rgba(0,0,0,0.8); color: white; padding: 12px; border-radius: 50px; text-align: center; font-weight: bold; z-index: 15; display: none;"></div>
                        
                        <!-- Close button -->
                        <button id="closeCameraBtn" class="btn btn-sm btn-danger" style="position: absolute; top: 10px; right: 10px; z-index: 20; border-radius: 50%; width: 40px; height: 40px;" onclick="closeCameraSection()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div id="attendanceFaceStatus" class="mt-3 fw-bold"></div>
                    <div class="progress mt-2" id="attendanceQualityBar" style="height: 8px;">
                        <div class="progress-bar" id="attendanceQualityFill" role="progressbar" style="width: 0%; background: #28a745;"></div>
                    </div>
                    
                    <div id="attendanceResult" class="mt-3"></div>
                    
                    <canvas id="cropCanvas" style="display:none;"></canvas>
                    <canvas id="attendanceCanvas" style="display:none;"></canvas>
                    <img id="attendanceSnapshot" style="max-width:100%; border-radius:10px; display:none;" class="mt-2">
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    #attendanceVideo { background: #000; border-radius: 8px; }
    .camera-container { position: relative; width: 100%; height: 350px; background: #000; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .flash-message { animation: flash 0.2s ease-out; }
    @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    .match-found { border-color: #28a745 !important; background-color: rgba(40, 167, 69, 0.2); }
    .recognizing { border-color: #ffc107 !important; background-color: rgba(255, 193, 7, 0.2); }
    #attendanceStatusOverlay { transition: all 0.3s ease; }
    #startCameraBtn {
        padding: 15px 40px;
        font-size: 1.2rem;
        transition: transform 0.2s;
    }
    #startCameraBtn:hover {
        transform: scale(1.05);
    }
</style>

<script>
let attendanceStream = null;
let isProcessing = false;
let hasCaptured = false;
let isSubmitting = false;
let detectionFrame = null;
let lastDetectionTime = 0;
let consecutiveGoodFrames = 0;
let matchFoundFrame = null;
let captureTimeout = null;
let currentEmployee = null;

const DETECTION_THROTTLE_MS = 200;
const FRAME_WIDTH = 198;
const FRAME_HEIGHT = 252;
const REQUIRED_GOOD_FRAMES = 5;
const MIN_QUALITY = 0.30;

const startButtonContainer = document.getElementById('startButtonContainer');
const attendanceCameraSection = document.getElementById('attendanceCameraSection');
const attendanceVideo = document.getElementById('attendanceVideo');
const attendanceSnapshot = document.getElementById('attendanceSnapshot');
const cropCanvas = document.getElementById('cropCanvas');
const attendanceResult = document.getElementById('attendanceResult');
const attendanceQualityBar = document.getElementById('attendanceQualityBar');
const attendanceQualityFill = document.getElementById('attendanceQualityFill');
const attendanceFaceStatus = document.getElementById('attendanceFaceStatus');
const attendanceFaceGuide = document.getElementById('attendanceFaceGuide');
const attendanceFaceGuideLabel = document.getElementById('attendanceFaceGuideLabel');
const attendanceStatusOverlay = document.getElementById('attendanceStatusOverlay');

function closeCameraSection() {
    console.log('üîí Closing camera section');
    stopAttendanceCamera();
    attendanceCameraSection.style.display = 'none';
    startButtonContainer.style.display = 'block';
    
    // Reset all states
    isProcessing = false;
    hasCaptured = false;
    isSubmitting = false;
    consecutiveGoodFrames = 0;
    matchFoundFrame = null;
    currentEmployee = null;
    
    // Clear any results
    attendanceResult.innerHTML = '';
    attendanceFaceStatus.innerHTML = '';
    attendanceQualityFill.style.width = '0%';
    attendanceStatusOverlay.style.display = 'none';
}

function startAttendanceCamera() {
    console.log('üì∑ Starting camera');
    startButtonContainer.style.display = 'none';
    attendanceCameraSection.style.display = 'block';
    
    // Reset states
    isProcessing = false;
    hasCaptured = false;
    isSubmitting = false;
    consecutiveGoodFrames = 0;
    matchFoundFrame = null;
    currentEmployee = null;
    attendanceResult.innerHTML = '';
    attendanceStatusOverlay.style.display = 'none';
    
    attendanceFaceStatus.innerHTML = 'üîç Initializing camera...';
    attendanceFaceStatus.className = 'text-info';
    
    navigator.mediaDevices.getUserMedia({ 
        video: { 
            facingMode: 'user', 
            width: { ideal: 640 }, 
            height: { ideal: 480 } 
        } 
    })
    .then(stream => {
        attendanceStream = stream;
        attendanceVideo.srcObject = stream;
        attendanceVideo.onloadedmetadata = () => {
            attendanceFaceStatus.innerHTML = 'üë§ Look at the camera';
            startAttendanceFaceDetection();
        };
    })
    .catch(err => {
        console.error('Camera error:', err);
        attendanceResult.innerHTML = `
            <div class="alert alert-danger">
                Camera access denied: ${err.message}
            </div>
        `;
        closeCameraSection();
    });
}

function stopAttendanceCamera() {
    console.log('üõë Stopping camera');
    if (attendanceStream) {
        attendanceStream.getTracks().forEach(track => track.stop());
        attendanceStream = null;
    }
    if (detectionFrame) {
        cancelAnimationFrame(detectionFrame);
        detectionFrame = null;
    }
    if (captureTimeout) {
        clearTimeout(captureTimeout);
        captureTimeout = null;
    }
}

async function detectFaceWithAPI() {
    if (!attendanceVideo || !attendanceVideo.videoWidth || isProcessing || hasCaptured || isSubmitting) return null;
    
    const now = Date.now();
    if (now - lastDetectionTime < DETECTION_THROTTLE_MS) return null;
    lastDetectionTime = now;
    
    const canvas = document.createElement('canvas');
    canvas.width = attendanceVideo.videoWidth;
    canvas.height = attendanceVideo.videoHeight;
    canvas.getContext('2d').drawImage(attendanceVideo, 0, 0);
    const imageData = canvas.toDataURL('image/jpeg', 0.8);
    
    try {
        const response = await fetch('/detect_face', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({image: imageData})
        });
        if (!response.ok) return null;
        return await response.json();
    } catch (error) {
        console.error('Face detection error:', error);
        return null;
    }
}

async function matchFaceWithAPI(imageData) {
    try {
        console.log('üîç Attempting to match face...');
        const response = await fetch('/match_face', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({image: imageData})
        });
        
        if (!response.ok) {
            console.error('Match face response not OK:', response.status);
            return null;
        }
        
        const data = await response.json();
        console.log('Match result:', data);
        return data;
    } catch (error) {
        console.error('Face matching error:', error);
        return null;
    }
}

function cropFaceFromFrame() {
    const video = attendanceVideo;
    const videoWidth = video.videoWidth;
    const videoHeight = video.videoHeight;
    const rect = attendanceVideo.getBoundingClientRect();
    const guideRect = attendanceFaceGuide.getBoundingClientRect();
    const scaleX = videoWidth / rect.width;
    const scaleY = videoHeight / rect.height;
    const guideLeft = (guideRect.left - rect.left) * scaleX;
    const guideTop = (guideRect.top - rect.top) * scaleY;
    const guideWidth = guideRect.width * scaleX;
    const guideHeight = guideRect.height * scaleY;
    
    cropCanvas.width = FRAME_WIDTH;
    cropCanvas.height = FRAME_HEIGHT;
    cropCanvas.getContext('2d').drawImage(video, guideLeft, guideTop, guideWidth, guideHeight, 0, 0, cropCanvas.width, cropCanvas.height);
    return cropCanvas.toDataURL('image/jpeg', 0.9);
}

async function startAttendanceFaceDetection() {
    const detectFaces = async () => {
        if (isProcessing || hasCaptured || isSubmitting) {
            detectionFrame = requestAnimationFrame(detectFaces);
            return;
        }
        
        const result = await detectFaceWithAPI();
        
        if (result && result.face_detected) {
            const qualityPercent = Math.round(result.quality * 100);
            attendanceQualityFill.style.width = `${qualityPercent}%`;
            
            if (result.quality >= MIN_QUALITY) {
                attendanceQualityFill.style.background = '#28a745';
                attendanceFaceGuide.style.borderColor = '#28a745';
                consecutiveGoodFrames++;
                
                attendanceFaceStatus.innerHTML = `‚úÖ Face detected (${qualityPercent}% quality)`;
                attendanceFaceStatus.className = 'text-success';
                attendanceFaceGuideLabel.textContent = '‚úÖ Processing...';
                
                if (consecutiveGoodFrames >= REQUIRED_GOOD_FRAMES && !matchFoundFrame) {
                    matchFoundFrame = true;
                    isProcessing = true;
                    
                    attendanceFaceStatus.innerHTML = 'üîç Matching with registered employees...';
                    attendanceStatusOverlay.style.display = 'block';
                    attendanceStatusOverlay.innerHTML = 'üîç Searching for match...';
                    
                    const croppedImageData = cropFaceFromFrame();
                    
                    const matchResult = await matchFaceWithAPI(croppedImageData);
                    
                    if (matchResult && matchResult.match_found) {
                        currentEmployee = matchResult.employee;
                        attendanceStatusOverlay.innerHTML = `‚úÖ Match found: ${currentEmployee.name}`;
                        attendanceStatusOverlay.style.background = 'rgba(40, 167, 69, 0.9)';
                        
                        attendanceFaceStatus.innerHTML = `‚úÖ Matched with ${currentEmployee.name} (${matchResult.confidence}%)`;
                        
                        console.log('‚úÖ Match successful, capturing in 1 second...');
                        captureTimeout = setTimeout(() => {
                            captureImmediately(currentEmployee.employeeid, croppedImageData);
                        }, 1000);
                    } else {
                        console.log('‚ùå No match found');
                        attendanceStatusOverlay.style.display = 'none';
                        attendanceFaceStatus.innerHTML = '‚ùå No matching employee found';
                        attendanceFaceStatus.className = 'text-danger';
                        attendanceFaceGuide.style.borderColor = '#dc3545';
                        
                        setTimeout(() => {
                            isProcessing = false;
                            matchFoundFrame = null;
                            consecutiveGoodFrames = 0;
                            attendanceStatusOverlay.style.display = 'none';
                            attendanceFaceStatus.innerHTML = 'üë§ Look at the camera';
                            attendanceFaceStatus.className = 'text-info';
                        }, 3000);
                    }
                }
            } else {
                attendanceQualityFill.style.background = '#ffc107';
                attendanceFaceGuide.style.borderColor = '#ffc107';
                attendanceFaceStatus.innerHTML = `‚ö†Ô∏è Low quality (${qualityPercent}%) - Move closer`;
                attendanceFaceStatus.className = 'text-warning';
                attendanceFaceGuideLabel.textContent = '‚ö†Ô∏è Low quality';
                consecutiveGoodFrames = 0;
                matchFoundFrame = null;
            }
        } else {
            attendanceQualityFill.style.width = '0%';
            attendanceFaceGuide.style.borderColor = 'rgba(255, 255, 255, 0.9)';
            attendanceFaceStatus.innerHTML = 'üë§ No face detected';
            attendanceFaceStatus.className = 'text-muted';
            attendanceFaceGuideLabel.textContent = 'Look here';
            consecutiveGoodFrames = 0;
            matchFoundFrame = null;
        }
        
        detectionFrame = requestAnimationFrame(detectFaces);
    };
    
    detectFaces();
}

function captureImmediately(empid, imageData) {
    if (hasCaptured || isSubmitting) return;
    hasCaptured = true;
    
    console.log('üì∏ Capturing image for employee:', empid);
    attendanceSnapshot.src = imageData;
    attendanceSnapshot.style.display = 'block';
    attendanceVideo.classList.add('flash-message');
    attendanceStatusOverlay.innerHTML = 'üì∏ Capturing...';
    
    setTimeout(() => {
        attendanceVideo.classList.remove('flash-message');
        submitLiveAttendance(empid, imageData);
    }, 200);
}

function submitLiveAttendance(empid, imageData) {
    if (isSubmitting) return;
    isSubmitting = true;
    
    console.log('üì§ Submitting attendance for employee:', empid);
    
    const formData = new URLSearchParams();
    formData.append('employeeid', empid);
    formData.append('captured_image', imageData);
    
    attendanceStatusOverlay.innerHTML = '‚è≥ Recording attendance...';
    attendanceFaceStatus.innerHTML = '‚è≥ Processing...';
    
    fetch('/live_attendance', { 
        method: 'POST', 
        body: formData,
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
    })
    .then(async response => {
        console.log('Response status:', response.status);
        const text = await response.text();
        console.log('Response text:', text);
        
        if (!response.ok) {
            try {
                const data = JSON.parse(text);
                throw new Error(data.msg || `Server error: ${response.status}`);
            } catch (e) {
                throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`);
            }
        }
        return JSON.parse(text);
    })
    .then(data => {
        console.log('‚úÖ Attendance success:', data);
        if (data.status === 'ok') {
            const action = data.action === 'signed_in' ? 'Signed In' : 'Signed Out';
            attendanceResult.innerHTML = `
                <div class="alert alert-success">
                    <strong>‚úÖ ${currentEmployee?.name || 'Employee'} ${action}!</strong><br>
                    <small>Confidence: ${data.confidence}%</small>
                </div>`;
            attendanceStatusOverlay.innerHTML = `‚úÖ ${action} successfully!`;
            attendanceStatusOverlay.style.background = 'rgba(40, 167, 69, 0.9)';
            
            // Auto-close after 2 seconds on success
            console.log('‚úÖ Success, closing in 2 seconds...');
            setTimeout(() => {
                closeCameraSection();
            }, 2000);
        } else {
            throw new Error(data.msg || 'Unknown error');
        }
    })
    .catch(err => {
        console.error('‚ùå Attendance submission error:', err);
        attendanceResult.innerHTML = `
            <div class="alert alert-danger">
                <strong>‚ùå Failed:</strong> ${err.message}<br>
                <small>Please try again</small>
            </div>`;
        attendanceStatusOverlay.style.display = 'none';
        
        // Reset on failure after a delay
        setTimeout(() => {
            isProcessing = false;
            hasCaptured = false;
            isSubmitting = false;
            matchFoundFrame = null;
            consecutiveGoodFrames = 0;
            attendanceSnapshot.style.display = 'none';
            attendanceFaceStatus.innerHTML = 'üë§ Try again - Look at the camera';
            attendanceFaceStatus.className = 'text-info';
        }, 3000);
    });
}

window.addEventListener('beforeunload', function() {
    stopAttendanceCamera();
});
</script>
{% endblock %}