{% extends "layout.html" %}
{% block body %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>Face Mismatch Detection
                        <span class="badge bg-light text-dark ms-2">Confidence Threshold: 65%</span>
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Filter Form -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="filterName" placeholder="Filter by Employee Name" value="{{ request.args.get('name', '') }}">
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control" id="filterDate" value="{{ request.args.get('date', '') }}">
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary w-100" onclick="applyFilters()">
                                <i class="fas fa-search me-2"></i>Filter
                            </button>
                        </div>
                        <div class="col-md-2">
                            <a href="{{ url_for('mismatch') }}" class="btn btn-secondary w-100">
                                <i class="fas fa-redo me-2"></i>Reset
                            </a>
                        </div>
                    </div>
                    
                    <!-- Export Button -->
                    <div class="mb-3">
                        <a href="{{ url_for('export_mismatch_pdf') }}" class="btn btn-danger" id="exportPdfBtn">
                            <i class="fas fa-file-pdf me-2"></i>Export to PDF
                        </a>
                    </div>
                    
                    <!-- Info Alert -->
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Match Threshold: 65%</strong> ‚Äî Confidence ‚â•65% = ‚úÖ Match | Confidence {'<'}65% = ‚ùå Mismatch
                    </div>
                    
                    {% if mismatches and mismatches|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered" id="mismatchTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Employee</th>
                                    <th>Date</th>
                                    <th>Time In</th>
                                    <th>Time Out</th>
                                    <th>Registered Photo</th>
                                    <th>Sign In Photo</th>
                                    <th>Sign Out Photo</th>
                                    <th>Sign In Match</th>
                                    <th>Sign Out Match</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in mismatches %}
                                {% set is_signin_match = item.signin_confidence is defined and item.signin_confidence >= 0.65 %}
                                {% set is_signout_match = item.signout_confidence is defined and item.signout_confidence >= 0.65 %}
                                {% set is_signin_mismatch = item.signin_confidence is defined and item.signin_confidence < 0.65 %}
                                {% set is_signout_mismatch = item.signout_confidence is defined and item.signout_confidence < 0.65 %}
                                {% set has_mismatch = is_signin_mismatch or is_signout_mismatch %}
                                <tr class="mismatch-row {% if has_mismatch %}table-danger{% endif %}" data-id="{{ item.id }}" style="cursor: pointer;">
                                    <td><strong>{{ item.id }}</strong></td>
                                    <td>{{ item.emp_name }}</td>
                                    <td>{{ item.date if item.date else 'N/A' }}</td>
                                    <td>{{ item.time_in }}</td>
                                    <td>{{ item.time_out }}</td>
                                    <td class="text-center">
                                        {% if item.reg_photo %}
                                        <img src="{{ url_for('uploads', filename=item.reg_photo) }}" 
                                             height="40" class="rounded" 
                                             onclick="showImage(this.src); event.stopPropagation();" style="cursor: pointer;">
                                        {% else %}
                                        <span class="badge bg-secondary">No Image</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if item.signin_photo %}
                                        <img src="{{ url_for('uploads', filename=item.signin_photo) }}" 
                                             height="40" class="rounded {% if is_signin_mismatch %}border border-danger border-2{% endif %}"
                                             onclick="showImage(this.src); event.stopPropagation();" style="cursor: pointer;">
                                        <br>
                                        <small>Conf: {{ (item.signin_confidence * 100)|round if item.signin_confidence else 0 }}%</small>
                                        {% else %}
                                        <span class="badge bg-secondary">No Image</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if item.signout_photo %}
                                        <img src="{{ url_for('uploads', filename=item.signout_photo) }}" 
                                             height="40" class="rounded {% if is_signout_mismatch %}border border-danger border-2{% endif %}"
                                             onclick="showImage(this.src); event.stopPropagation();" style="cursor: pointer;">
                                        <br>
                                        <small>Conf: {{ (item.signout_confidence * 100)|round if item.signout_confidence else 0 }}%</small>
                                        {% else %}
                                        <span class="badge bg-secondary">No Image</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if is_signin_match %}
                                        <span class="badge bg-success">‚úÖ Match</span>
                                        {% else %}
                                        <span class="badge bg-danger">‚ùå Mismatch</span>
                                        {% endif %}
                                        <br><small>{{ (item.signin_confidence * 100)|round if item.signin_confidence else 0 }}%</small>
                                    </td>
                                    <td class="text-center">
                                        {% if is_signout_match %}
                                        <span class="badge bg-success">‚úÖ Match</span>
                                        {% else %}
                                        <span class="badge bg-danger">‚ùå Mismatch</span>
                                        {% endif %}
                                        <br><small>{{ (item.signout_confidence * 100)|round if item.signout_confidence else 0 }}%</small>
                                    </td>
                                    <td onclick="event.stopPropagation();">
                                        <button class="btn btn-sm btn-danger" onclick="deleteMismatch({{ item.id }})">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <div class="display-1 text-success mb-4">‚úÖ</div>
                        <h3>No Face Mismatches Found!</h3>
                        <p class="text-muted">All face recognition matches have confidence <strong>‚â•65%</strong>.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Receipt Modal -->
<div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="receiptModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>FACE VERIFICATION DETAILS
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="receiptContent">
                <div class="text-center mb-4">
                    <div class="spinner-border text-danger" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading details...</p>
                </div>
            </div>
            <div class="modal-footer">
                <div class="btn-group w-100" role="group">
                    <button class="btn btn-success" onclick="shareReceipt('whatsapp')">
                        <i class="fab fa-whatsapp me-2"></i>WhatsApp
                    </button>
                    <button class="btn btn-info" onclick="shareReceipt('telegram')">
                        <i class="fab fa-telegram me-2"></i>Telegram
                    </button>
                    <button class="btn btn-primary" onclick="shareReceipt('facebook')">
                        <i class="fab fa-facebook me-2"></i>Facebook
                    </button>
                    <button class="btn btn-secondary" onclick="shareReceipt('copy')">
                        <i class="fas fa-copy me-2"></i>Copy
                    </button>
                </div>
                <button type="button" class="btn btn-secondary w-100 mt-2" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Face Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid rounded">
            </div>
        </div>
    </div>
</div>

<script>
let imageModal;
let currentReceiptData = null;
const MATCH_THRESHOLD = 65; // 65% threshold

document.addEventListener('DOMContentLoaded', function() {
    imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
    
    // Make rows clickable
    document.querySelectorAll('.mismatch-row').forEach(row => {
        row.addEventListener('click', function(e) {
            // Don't trigger if clicking on buttons or images
            if (e.target.tagName === 'BUTTON' || 
                e.target.tagName === 'A' || 
                e.target.tagName === 'I' ||
                e.target.closest('button') ||
                e.target.tagName === 'IMG') {
                return;
            }
            const id = this.dataset.id;
            showReceipt(id);
        });
    });
});

function showImage(src) {
    document.getElementById('modalImage').src = src;
    imageModal.show();
}

function applyFilters() {
    const name = document.getElementById('filterName').value;
    const date = document.getElementById('filterDate').value;
    const params = new URLSearchParams();
    
    if (name) params.append('name', name);
    if (date) params.append('date', date);
    
    window.location.href = `{{ url_for('mismatch') }}?${params.toString()}`;
}

function deleteMismatch(id) {
    if (!confirm('Are you sure you want to delete this mismatch record?')) return;
    
    fetch(`/timesheet/mismatch/delete/${id}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'ok') {
                location.reload();
            } else {
                alert('Error: ' + data.msg);
            }
        })
        .catch(() => alert('Network error'));
}

async function showReceipt(id) {
    const modal = new bootstrap.Modal(document.getElementById('receiptModal'));
    const content = document.getElementById('receiptContent');
    
    // Show loading
    content.innerHTML = `
        <div class="text-center mb-4">
            <div class="spinner-border text-danger" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading details...</p>
        </div>
    `;
    
    modal.show();
    
    try {
        // Find the record from the table data
        const row = document.querySelector(`.mismatch-row[data-id="${id}"]`);
        if (!row) throw new Error('Record not found');
        
        const cells = row.cells;
        
        // Get image sources
        const images = [];
        const regImg = cells[5].querySelector('img');
        const signinImg = cells[6].querySelector('img');
        const signoutImg = cells[7].querySelector('img');
        
        // Extract confidence values
        const signinConfText = cells[6].innerText.match(/Conf: ([\d.]+)%/)?.[1] || '0';
        const signoutConfText = cells[7].innerText.match(/Conf: ([\d.]+)%/)?.[1] || '0';
        
        const signinConf = parseFloat(signinConfText);
        const signoutConf = parseFloat(signoutConfText);
        
        const data = {
            id: id,
            employee_name: cells[1].innerText,
            date: cells[2].innerText,
            time_in: cells[3].innerText,
            time_out: cells[4].innerText,
            reg_photo: regImg ? regImg.src : null,
            signin_photo: signinImg ? signinImg.src : null,
            signout_photo: signoutImg ? signoutImg.src : null,
            signin_match: signinConf >= MATCH_THRESHOLD,
            signout_match: signoutConf >= MATCH_THRESHOLD,
            signin_confidence: signinConfText,
            signout_confidence: signoutConfText
        };
        
        currentReceiptData = data;
        
        // Generate receipt HTML
        content.innerHTML = generateReceiptHTML(data);
        
    } catch (error) {
        content.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error loading details: ${error.message}
            </div>
        `;
    }
}

function generateReceiptHTML(data) {
    const signinMatch = parseFloat(data.signin_confidence) >= MATCH_THRESHOLD;
    const signoutMatch = parseFloat(data.signout_confidence) >= MATCH_THRESHOLD;
    const hasMismatch = !signinMatch || !signoutMatch;
    
    return `
        <div class="receipt-container" style="font-family: 'Courier New', monospace; background: #f8f9fa; padding: 20px; border-radius: 10px;">
            <!-- Header -->
            <div class="text-center mb-4">
                <h4 style="color: #dc3545;">üìã FACE VERIFICATION DETAILS</h4>
                <div style="border-bottom: 2px dashed #dc3545; margin: 10px 0;"></div>
                <small class="text-muted">Record #: ${data.id} | ${data.date}</small>
                <div class="mt-2">
                    <span class="badge bg-info">Match Threshold: ${MATCH_THRESHOLD}%</span>
                    <span class="badge bg-secondary">‚â•${MATCH_THRESHOLD}% = Match | <${MATCH_THRESHOLD}% = Mismatch</span>
                </div>
            </div>
            
            <!-- Employee Details -->
            <div class="row mb-3">
                <div class="col-12">
                    <strong>Employee:</strong> ${data.employee_name}<br>
                    <strong>Date:</strong> ${data.date}<br>
                    <strong>Time In:</strong> ${data.time_in}<br>
                    <strong>Time Out:</strong> ${data.time_out}
                </div>
            </div>
            
            <!-- Face Images -->
            <div class="row mb-3">
                <div class="col-4 text-center">
                    <strong>Registered</strong><br>
                    ${data.reg_photo ? 
                        `<img src="${data.reg_photo}" style="max-width: 100%; height: 100px; object-fit: cover; border-radius: 5px; cursor: pointer;" onclick="showImage('${data.reg_photo}')">` : 
                        '<div class="bg-secondary text-white p-2 rounded">No Image</div>'}
                </div>
                <div class="col-4 text-center">
                    <strong>Sign In</strong><br>
                    ${data.signin_photo ? 
                        `<img src="${data.signin_photo}" style="max-width: 100%; height: 100px; object-fit: cover; border-radius: 5px; ${!signinMatch ? 'border: 3px solid #dc3545;' : 'border: 2px solid #28a745;'} cursor: pointer;" onclick="showImage('${data.signin_photo}')">` : 
                        '<div class="bg-secondary text-white p-2 rounded">No Image</div>'}
                    <small>Conf: ${data.signin_confidence}%</small>
                </div>
                <div class="col-4 text-center">
                    <strong>Sign Out</strong><br>
                    ${data.signout_photo ? 
                        `<img src="${data.signout_photo}" style="max-width: 100%; height: 100px; object-fit: cover; border-radius: 5px; ${!signoutMatch ? 'border: 3px solid #dc3545;' : 'border: 2px solid #28a745;'} cursor: pointer;" onclick="showImage('${data.signout_photo}')">` : 
                        '<div class="bg-secondary text-white p-2 rounded">No Image</div>'}
                    <small>Conf: ${data.signout_confidence}%</small>
                </div>
            </div>
            
            <!-- Match Status -->
            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <div class="row text-center">
                    <div class="col-6">
                        <strong>Sign In:</strong><br>
                        <span class="badge ${signinMatch ? 'bg-success' : 'bg-danger'} p-2" style="font-size: 1rem;">
                            ${signinMatch ? '‚úÖ MATCH' : '‚ùå MISMATCH'}
                        </span>
                        <br><small>Confidence: ${data.signin_confidence}%</small>
                    </div>
                    <div class="col-6">
                        <strong>Sign Out:</strong><br>
                        <span class="badge ${signoutMatch ? 'bg-success' : 'bg-danger'} p-2" style="font-size: 1rem;">
                            ${signoutMatch ? '‚úÖ MATCH' : '‚ùå MISMATCH'}
                        </span>
                        <br><small>Confidence: ${data.signout_confidence}%</small>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <strong>Threshold:</strong> ${MATCH_THRESHOLD}% (‚â•${MATCH_THRESHOLD}% = Match | <${MATCH_THRESHOLD}% = Mismatch)
                </div>
            </div>
            
            <!-- Footer -->
            <div class="text-center mt-4">
                <div style="border-top: 1px dashed #dc3545; padding-top: 10px;">
                    <small class="text-muted">
                        Generated on ${new Date().toLocaleString()}<br>
                        This is a computer generated verification report.
                    </small>
                </div>
            </div>
        </div>
    `;
}

function shareReceipt(platform) {
    if (!currentReceiptData) return;
    
    const data = currentReceiptData;
    const signinMatch = parseFloat(data.signin_confidence) >= MATCH_THRESHOLD;
    const signoutMatch = parseFloat(data.signout_confidence) >= MATCH_THRESHOLD;
    
    const shareText = `üìã FACE VERIFICATION REPORT
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Employee: ${data.employee_name}
Date: ${data.date}
Time In: ${data.time_in}
Time Out: ${data.time_out}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Sign In: ${signinMatch ? '‚úÖ MATCH' : '‚ùå MISMATCH'} (${data.signin_confidence}%)
Sign Out: ${signoutMatch ? '‚úÖ MATCH' : '‚ùå MISMATCH'} (${data.signout_confidence}%)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Threshold: ${MATCH_THRESHOLD}% (‚â•${MATCH_THRESHOLD}% = Match | <${MATCH_THRESHOLD}% = Mismatch)
Generated: ${new Date().toLocaleString()}`;

    const encodedText = encodeURIComponent(shareText);
    
    switch(platform) {
        case 'whatsapp':
            window.open(`https://wa.me/?text=${encodedText}`, '_blank');
            break;
        case 'telegram':
            window.open(`https://t.me/share/url?url=${encodedText}`, '_blank');
            break;
        case 'facebook':
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodedText}`, '_blank');
            break;
        case 'copy':
            navigator.clipboard.writeText(shareText).then(() => {
                alert('Report copied to clipboard!');
            }).catch(() => {
                alert('Failed to copy to clipboard');
            });
            break;
    }
}
</script>

<style>
.mismatch-row:hover {
    background-color: rgba(220, 53, 69, 0.1) !important;
    transition: background-color 0.2s;
}
.table td {
    vertical-align: middle;
}
.badge {
    font-size: 0.8rem;
    padding: 0.4rem 0.6rem;
}
.receipt-container {
    font-family: 'Courier New', monospace;
}
.receipt-container img {
    cursor: pointer;
    transition: transform 0.2s;
}
.receipt-container img:hover {
    transform: scale(1.5);
    z-index: 100;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
.modal-lg {
    max-width: 700px;
}
</style>
{% endblock %}