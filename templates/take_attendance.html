{% extends "layout.html" %}
{% block body %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body text-center">
                <h2>üìù Take Attendance</h2>
                <form id="attendanceForm">
                    <div class="mb-3">
                        <label class="form-label">Employee ID</label>
                        <input type="text" class="form-control" id="attendanceEmpid" placeholder="FKEE0001" required autofocus>
                        <div id="attendanceValidationMsg" class="mt-2"></div>
                    </div>
                    
                    <div id="attendanceCameraSection" style="display:none;">
                        <label class="form-label">üì∏ Face Detection (Auto-attendance in 3s)</label>
                        <div class="position-relative">
                            <video id="attendanceVideo" width="100%" height="300" autoplay muted></video>
                            <canvas id="attendanceFaceOverlay" class="position-absolute top-0 start-0" 
                                    style="pointer-events:none; width:100%; height:100%;"></canvas>
                        </div>
                        <canvas id="attendanceCanvas" style="display:none;"></canvas>
                        <div id="attendanceCountdown" class="mt-2 fs-3 fw-bold text-success" style="display:none;">3</div>
                        <img id="attendanceSnapshot" style="max-width:100%; border-radius:10px; display:none;" class="mt-2">
                    </div>
                    
                    <button type="submit" class="btn btn-success btn-lg w-100 mt-3" id="attendanceBtn" disabled style="display:none;">
                        ‚úÖ Auto Take Attendance
                    </button>
                </form>
                <div id="attendanceResultBox" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<script>
let attendanceStream = null;
let attendanceCountdownTimer = null;
let attendanceFaceDetected = false;

const attendanceEmpidInput = document.getElementById('attendanceEmpid');
const attendanceValidationMsg = document.getElementById('attendanceValidationMsg');
const attendanceCameraSection = document.getElementById('attendanceCameraSection');
const attendanceVideo = document.getElementById('attendanceVideo');
const attendanceFaceOverlay = document.getElementById('attendanceFaceOverlay');
const attendanceCountdown = document.getElementById('attendanceCountdown');
const attendanceSnapshot = document.getElementById('attendanceSnapshot');
const attendanceBtn = document.getElementById('attendanceBtn');
const attendanceCanvas = document.getElementById('attendanceCanvas');
const attendanceResultBox = document.getElementById('attendanceResultBox');

// Validate ID on input + AUTO-CAMERA
attendanceEmpidInput.addEventListener('input', function() {
    const empid = this.value.trim();
    if (empid.length >= 7) {
        fetch(`/employees?employeeid=${encodeURIComponent(empid)}`)
            .then(response => response.text())
            .then(data => {
                if (data.includes(empid)) {
                    attendanceValidationMsg.innerHTML = `<div class="alert alert-success">‚úÖ Employee validated! Camera activating...</div>`;
                    setTimeout(startAttendanceCamera, 500);
                } else {
                    attendanceValidationMsg.innerHTML = `<div class="alert alert-danger">‚ùå Invalid Employee ID</div>`;
                    stopAttendanceCamera();
                }
            })
            .catch(() => {
                attendanceValidationMsg.innerHTML = `<div class="alert alert-danger">‚ùå Invalid Employee ID</div>`;
                stopAttendanceCamera();
            });
    } else {
        attendanceValidationMsg.innerHTML = '';
        stopAttendanceCamera();
    }
});

function startAttendanceCamera() {
    attendanceCameraSection.style.display = 'block';
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: 640, height: 480 } })
        .then(stream => {
            attendanceStream = stream;
            attendanceVideo.srcObject = stream;
            attendanceVideo.onloadedmetadata = () => {
                startAttendanceFaceDetection();
            };
        })
        .catch(err => {
            attendanceValidationMsg.innerHTML = `<div class="alert alert-danger">Camera access denied: ${err.message}</div>`;
        });
}

function stopAttendanceCamera() {
    attendanceCameraSection.style.display = 'none';
    if (attendanceStream) {
        attendanceStream.getTracks().forEach(track => track.stop());
    }
    attendanceFaceDetected = false;
    if (attendanceCountdownTimer) clearInterval(attendanceCountdownTimer);
    attendanceSnapshot.style.display = 'none';
    attendanceBtn.style.display = 'none';
}

function startAttendanceFaceDetection() {
    const detectFaces = () => {
        const ctx = attendanceFaceOverlay.getContext('2d');
        ctx.clearRect(0, 0, attendanceFaceOverlay.width, attendanceFaceOverlay.height);
        
        const rect = attendanceVideo.getBoundingClientRect();
        attendanceFaceOverlay.width = rect.width;
        attendanceFaceOverlay.height = rect.height;
        
        const radius = Math.min(rect.width, rect.height) / 3;
        ctx.beginPath();
        ctx.arc(rect.width/2, rect.height/2, radius, 0, 2 * Math.PI);
        ctx.strokeStyle = attendanceFaceDetected ? '#00ff00' : '#ff4444';
        ctx.lineWidth = 6;
        ctx.shadowColor = attendanceFaceDetected ? '#00ff00' : '#ff4444';
        ctx.shadowBlur = 20;
        ctx.stroke();
        
        const canvasTemp = document.createElement('canvas');
        canvasTemp.width = 100; canvasTemp.height = 100;
        const tempCtx = canvasTemp.getContext('2d');
        tempCtx.drawImage(attendanceVideo, rect.width/2-50, rect.height/2-50, 100, 100, 0, 0, 100, 100);
        
        const imageData = tempCtx.getImageData(0, 0, 100, 100);
        let brightness = 0;
        for (let i = 0; i < imageData.data.length; i += 4) {
            brightness += imageData.data[i] + imageData.data[i+1] + imageData.data[i+2];
        }
        brightness /= (imageData.data.length / 4 * 3);
        
        attendanceFaceDetected = brightness > 80 && brightness < 180;
        
        if (attendanceFaceDetected) startAttendanceCountdown();
        requestAnimationFrame(detectFaces);
    };
    detectFaces();
}

function startAttendanceCountdown() {
    if (attendanceCountdownTimer) clearInterval(attendanceCountdownTimer);
    let count = 1;
    attendanceCountdown.style.display = 'block';
    attendanceCountdownTimer = setInterval(() => {
        count--;
        attendanceCountdown.textContent = count;
        if (count <= 0) {
            clearInterval(attendanceCountdownTimer);
            attendanceAutoSnap();
        }
    }, 1000);
}

function attendanceAutoSnap() {
    attendanceCanvas.width = attendanceVideo.videoWidth;
    attendanceCanvas.height = attendanceVideo.videoHeight;
    attendanceCanvas.getContext('2d').drawImage(attendanceVideo, 0, 0);
    attendanceSnapshot.src = attendanceCanvas.toDataURL('image/png');
    attendanceSnapshot.style.display = 'block';
    attendanceBtn.style.display = 'block';
    
    setTimeout(() => {
        document.getElementById('attendanceForm').dispatchEvent(new Event('submit'));
    }, 500);
}

// ‚úÖ AUTO-RELOAD VERSION
document.getElementById('attendanceForm').onsubmit = function(e) {
    e.preventDefault();
    const empid = document.getElementById('attendanceEmpid').value.trim();
    if (!empid || attendanceSnapshot.style.display === 'none') {
        alert('Please wait for auto-attendance!');
        return;
    }
    
    const formData = new URLSearchParams();
    formData.append('employeeid', empid);
    formData.append('captured_image', attendanceSnapshot.src);
    
    fetch('/take_attendance', { method: 'POST', body: formData })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                // ‚úÖ FULL PAGE RELOAD AFTER SUCCESS
                location.reload();
            } else {
                attendanceResultBox.innerHTML = `
                    <div class="alert alert-danger alert-dismissible fade show">
                        ‚ùå ${data.msg || 'Error occurred'}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>`;
            }
        })
        .catch(err => {
            attendanceResultBox.innerHTML = `<div class="alert alert-danger">Network error: ${err.message}</div>`;
        });
};
</script>
{% endblock %}
