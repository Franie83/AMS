{% extends "layout.html" %}
{% block body %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body text-center">
                <h2>üìù Take Attendance</h2>
                <form id="attendanceForm">
                    <div class="mb-3">
                        <label class="form-label">Employee ID</label>
                        <input type="text" class="form-control" id="attendanceEmpid" placeholder="Enter Employee ID (e.g., FKEE0001)" required autofocus>
                        <div id="attendanceValidationMsg" class="mt-2"></div>
                    </div>
                    
                    <div id="attendanceCameraSection" style="display:none;">
                        <label class="form-label">üì∏ Face Detection - Position your face in the frame</label>
                        <div class="camera-container" style="position: relative; width: 100%; height: 350px; background: #000; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                            <video id="attendanceVideo" width="100%" height="100%" autoplay muted playsinline style="object-fit: cover;"></video>
                            <!-- Egg-shaped face guide -->
                            <div id="attendanceFaceGuide" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 198px; height: 252px; border: 4px solid rgba(255, 255, 255, 0.9); border-radius: 50% 50% 45% 45% / 55% 55% 45% 45%; box-shadow: 0 0 0 2000px rgba(128, 128, 128, 0.95); pointer-events: none; transition: border-color 0.3s ease; z-index: 10;">
                                <div id="attendanceFaceGuideLabel" style="position: absolute; bottom: -35px; left: 50%; transform: translateX(-50%); color: white; font-size: 14px; white-space: nowrap; text-shadow: 1px 1px 2px black; background: rgba(0,0,0,0.7); padding: 5px 15px; border-radius: 20px; pointer-events: none; z-index: 11;">Position face here</div>
                            </div>
                        </div>
                        
                        <!-- Status Messages -->
                        <div id="attendanceFaceStatus" class="mt-2 fw-bold"></div>
                        
                        <!-- Quality Indicator -->
                        <div class="progress mt-2" id="attendanceQualityBar" style="height: 8px; display: none;">
                            <div class="progress-bar" id="attendanceQualityFill" role="progressbar" style="width: 0%; background: #28a745;"></div>
                        </div>
                        
                        <!-- Position Feedback -->
                        <div id="positionFeedback" class="mt-2" style="display: none; padding: 8px; border-radius: 5px; font-weight: 500;"></div>
                        
                        <!-- Hidden canvas for cropping -->
                        <canvas id="cropCanvas" style="display:none;"></canvas>
                        <canvas id="attendanceCanvas" style="display:none;"></canvas>
                        
                        <!-- Cropped Preview -->
                        <img id="attendanceSnapshot" style="max-width:100%; border-radius:10px; display:none;" class="mt-2">
                    </div>
                </form>
                <div id="attendanceResultBox" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<style>
    .flash-message {
        animation: flash 0.2s ease-out;
    }
    @keyframes flash {
        0% { opacity: 1; }
        50% { opacity: 0.3; }
        100% { opacity: 1; }
    }
    #attendanceVideo {
        background: #000;
        border-radius: 8px;
    }
    .camera-container {
        position: relative;
        width: 100%;
        height: 350px;
        background: #000;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .position-warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
    }
    .position-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .position-info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    .quality-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-top: 5px;
    }
    .quality-high {
        background-color: #28a745;
        color: white;
    }
    .quality-medium {
        background-color: #ffc107;
        color: #212529;
    }
    .quality-low {
        background-color: #dc3545;
        color: white;
    }
</style>

<script>
let attendanceStream = null;
let attendanceFaceDetected = false;
let isProcessing = false;
let hasCaptured = false;
let isSubmitting = false;
let detectionFrame = null;
let currentEmpId = '';
let cameraStarted = false;
let lastDetectionTime = 0;
let consecutiveDetections = 0;
let lastValidFaceTime = 0;
const DETECTION_THROTTLE_MS = 200;
const FRAME_WIDTH = 198;
const FRAME_HEIGHT = 252;
const REQUIRED_CONSECUTIVE = 3; // Need 3 consecutive good detections
const MIN_QUALITY = 0.80; // 80% minimum quality threshold
const HIGH_QUALITY = 0.90; // 90% for excellent quality

const attendanceEmpidInput = document.getElementById('attendanceEmpid');
const attendanceValidationMsg = document.getElementById('attendanceValidationMsg');
const attendanceCameraSection = document.getElementById('attendanceCameraSection');
const attendanceVideo = document.getElementById('attendanceVideo');
const attendanceSnapshot = document.getElementById('attendanceSnapshot');
const attendanceCanvas = document.getElementById('attendanceCanvas');
const cropCanvas = document.getElementById('cropCanvas');
const attendanceResultBox = document.getElementById('attendanceResultBox');
const attendanceQualityBar = document.getElementById('attendanceQualityBar');
const attendanceQualityFill = document.getElementById('attendanceQualityFill');
const attendanceFaceStatus = document.getElementById('attendanceFaceStatus');
const attendanceFaceGuide = document.getElementById('attendanceFaceGuide');
const attendanceFaceGuideLabel = document.getElementById('attendanceFaceGuideLabel');
const positionFeedback = document.getElementById('positionFeedback');

// Clear on page load
window.addEventListener('load', function() {
    attendanceEmpidInput.value = '';
    attendanceEmpidInput.focus();
    stopAttendanceCamera();
});

// Validate ID on input
attendanceEmpidInput.addEventListener('input', function() {
    const empid = this.value.trim().toUpperCase();
    this.value = empid;
    
    if (empid.length >= 4) {
        attendanceValidationMsg.innerHTML = `<div class="alert alert-info">‚è≥ Validating employee ID...</div>`;
        
        fetch(`/employees?employeeid=${encodeURIComponent(empid)}`)
            .then(response => response.text())
            .then(data => {
                if (data.includes(empid)) {
                    attendanceValidationMsg.innerHTML = `<div class="alert alert-success">‚úÖ Employee ${empid} found! Starting camera...</div>`;
                    currentEmpId = empid;
                    
                    if (!cameraStarted && !hasCaptured && !isSubmitting) {
                        setTimeout(() => startAttendanceCamera(), 500);
                    }
                } else {
                    attendanceValidationMsg.innerHTML = `<div class="alert alert-danger">‚ùå Employee ID ${empid} not found</div>`;
                    stopAttendanceCamera();
                    cameraStarted = false;
                }
            })
            .catch(err => {
                console.error('Validation error:', err);
                attendanceValidationMsg.innerHTML = `<div class="alert alert-danger">‚ùå Error validating employee ID</div>`;
                stopAttendanceCamera();
                cameraStarted = false;
            });
    } else {
        attendanceValidationMsg.innerHTML = '';
        stopAttendanceCamera();
        cameraStarted = false;
    }
});

// Face detection API call
async function detectFaceWithAPI() {
    if (!attendanceVideo || !attendanceVideo.videoWidth || isProcessing || hasCaptured || isSubmitting) return null;
    
    const now = Date.now();
    if (now - lastDetectionTime < DETECTION_THROTTLE_MS) {
        return null;
    }
    
    lastDetectionTime = now;
    
    const canvas = document.createElement('canvas');
    canvas.width = attendanceVideo.videoWidth;
    canvas.height = attendanceVideo.videoHeight;
    canvas.getContext('2d').drawImage(attendanceVideo, 0, 0);
    const imageData = canvas.toDataURL('image/jpeg', 0.8);
    
    try {
        const response = await fetch('/detect_face', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({image: imageData})
        });
        
        if (!response.ok) {
            console.error('Detection API returned:', response.status);
            return null;
        }
        
        const result = await response.json();
        return result;
    } catch (error) {
        console.error('Face detection API error:', error);
        return null;
    }
}

function getQualityClass(quality) {
    if (quality >= HIGH_QUALITY) return 'quality-high';
    if (quality >= MIN_QUALITY) return 'quality-medium';
    return 'quality-low';
}

function startAttendanceCamera() {
    if (cameraStarted || hasCaptured || isSubmitting) return;
    
    cameraStarted = true;
    isProcessing = false;
    consecutiveDetections = 0;
    attendanceCameraSection.style.display = 'block';
    attendanceFaceStatus.innerHTML = 'üîç Detecting face...';
    attendanceFaceStatus.className = 'text-info';
    attendanceEmpidInput.disabled = true;
    positionFeedback.style.display = 'block';
    positionFeedback.className = 'position-info';
    positionFeedback.innerHTML = 'üë§ Please position your face in the frame (80% quality required)';
    
    navigator.mediaDevices.getUserMedia({ 
        video: { 
            facingMode: 'user', 
            width: { ideal: 640 },
            height: { ideal: 480 }
        } 
    })
    .then(stream => {
        attendanceStream = stream;
        attendanceVideo.srcObject = stream;
        attendanceVideo.onloadedmetadata = () => {
            startAttendanceFaceDetection();
        };
    })
    .catch(err => {
        attendanceValidationMsg.innerHTML = `<div class="alert alert-danger">Camera access denied: ${err.message}</div>`;
        attendanceEmpidInput.disabled = false;
        cameraStarted = false;
        positionFeedback.style.display = 'none';
    });
}

function stopAttendanceCamera() {
    attendanceCameraSection.style.display = 'none';
    if (attendanceStream) {
        attendanceStream.getTracks().forEach(track => track.stop());
        attendanceStream = null;
    }
    attendanceFaceDetected = false;
    isProcessing = false;
    cameraStarted = false;
    consecutiveDetections = 0;
    attendanceEmpidInput.disabled = false;
    if (detectionFrame) cancelAnimationFrame(detectionFrame);
    attendanceSnapshot.style.display = 'none';
    attendanceQualityBar.style.display = 'none';
    attendanceFaceStatus.innerHTML = '';
    positionFeedback.style.display = 'none';
    attendanceFaceGuide.style.borderColor = 'rgba(255, 255, 255, 0.9)';
    attendanceFaceGuideLabel.textContent = 'Position face here';
}

function cropFaceFromFrame() {
    const video = attendanceVideo;
    const videoWidth = video.videoWidth;
    const videoHeight = video.videoHeight;
    
    // Get the position of the face guide relative to video
    const rect = attendanceVideo.getBoundingClientRect();
    const guideRect = attendanceFaceGuide.getBoundingClientRect();
    
    // Calculate the face guide position in video coordinates
    const scaleX = videoWidth / rect.width;
    const scaleY = videoHeight / rect.height;
    
    const guideLeft = (guideRect.left - rect.left) * scaleX;
    const guideTop = (guideRect.top - rect.top) * scaleY;
    const guideWidth = guideRect.width * scaleX;
    const guideHeight = guideRect.height * scaleY;
    
    // Set crop canvas size to frame dimensions
    cropCanvas.width = FRAME_WIDTH;
    cropCanvas.height = FRAME_HEIGHT;
    
    // Draw the cropped face
    const ctx = cropCanvas.getContext('2d');
    ctx.drawImage(
        video,
        guideLeft, guideTop, guideWidth, guideHeight,
        0, 0, cropCanvas.width, cropCanvas.height
    );
    
    return cropCanvas.toDataURL('image/jpeg', 0.9);
}

async function startAttendanceFaceDetection() {
    const detectFaces = async () => {
        if (isProcessing || hasCaptured || isSubmitting) {
            detectionFrame = requestAnimationFrame(detectFaces);
            return;
        }
        
        const result = await detectFaceWithAPI();
        
        if (result && !isProcessing && !hasCaptured && !isSubmitting) {
            attendanceFaceDetected = result.face_detected;
            
            if (result.face_detected) {
                // Show quality
                attendanceQualityBar.style.display = 'block';
                const qualityPercent = Math.round(result.quality * 100);
                attendanceQualityFill.style.width = `${qualityPercent}%`;
                
                // Update color based on quality
                if (result.quality >= HIGH_QUALITY) {
                    attendanceQualityFill.style.background = '#28a745'; // Green for excellent
                } else if (result.quality >= MIN_QUALITY) {
                    attendanceQualityFill.style.background = '#ffc107'; // Yellow for good
                } else {
                    attendanceQualityFill.style.background = '#dc3545'; // Red for poor
                }
                
                // Update status based on quality
                if (result.quality >= MIN_QUALITY) {
                    // Good quality face detected (80% or above)
                    attendanceFaceGuide.style.borderColor = '#28a745';
                    
                    consecutiveDetections++;
                    
                    if (consecutiveDetections >= REQUIRED_CONSECUTIVE) {
                        // Face has been detected with good quality consistently
                        const qualityEmoji = result.quality >= HIGH_QUALITY ? 'üåü' : '‚úÖ';
                        attendanceFaceStatus.innerHTML = `${qualityEmoji} Excellent quality (${qualityPercent}%)! Capturing...`;
                        attendanceFaceStatus.className = 'text-success';
                        attendanceFaceGuideLabel.textContent = '‚úÖ Perfect!';
                        positionFeedback.innerHTML = `${qualityEmoji} Quality: ${qualityPercent}% - Capturing...`;
                        positionFeedback.className = 'position-success';
                        captureImmediately();
                    } else {
                        // Show progress
                        const progress = Math.round((consecutiveDetections / REQUIRED_CONSECUTIVE) * 100);
                        attendanceFaceStatus.innerHTML = `‚úÖ Quality: ${qualityPercent}% - Hold still... ${progress}%`;
                        attendanceFaceStatus.className = 'text-success';
                        attendanceFaceGuideLabel.textContent = '‚úÖ Hold still';
                        positionFeedback.innerHTML = `‚úÖ Quality: ${qualityPercent}% - Please hold still (${progress}%)`;
                        positionFeedback.className = 'position-info';
                    }
                } else {
                    // Quality too low (below 80%)
                    attendanceQualityFill.style.background = '#dc3545';
                    attendanceFaceStatus.innerHTML = `‚ö†Ô∏è Quality too low: ${qualityPercent}% (need 80%)`;
                    attendanceFaceStatus.className = 'text-warning';
                    attendanceFaceGuide.style.borderColor = '#ffc107';
                    attendanceFaceGuideLabel.textContent = '‚ö†Ô∏è Low quality';
                    positionFeedback.innerHTML = `‚ö†Ô∏è Face quality: ${qualityPercent}% - Need 80% or higher. Please ensure good lighting.`;
                    positionFeedback.className = 'position-warning';
                    consecutiveDetections = 0; // Reset counter
                }
            } else {
                // No face detected
                attendanceQualityBar.style.display = 'none';
                attendanceFaceStatus.innerHTML = 'üë§ No face detected';
                attendanceFaceStatus.className = 'text-muted';
                attendanceFaceGuide.style.borderColor = 'rgba(255, 255, 255, 0.9)';
                attendanceFaceGuideLabel.textContent = 'Position face here';
                positionFeedback.innerHTML = 'üë§ Please position your face in the frame';
                positionFeedback.className = 'position-info';
                consecutiveDetections = 0; // Reset counter
            }
        }
        
        detectionFrame = requestAnimationFrame(detectFaces);
    };
    
    detectFaces();
}

function captureImmediately() {
    if (isProcessing || hasCaptured || isSubmitting) return;
    
    isProcessing = true;
    hasCaptured = true;
    
    attendanceFaceStatus.innerHTML = `üì∏ Capturing...`;
    attendanceFaceStatus.className = 'text-info';
    
    // Flash effect
    attendanceVideo.classList.add('flash-message');
    setTimeout(() => attendanceVideo.classList.remove('flash-message'), 200);
    
    // Crop face from frame
    const croppedImageData = cropFaceFromFrame();
    
    // Show preview of cropped face
    attendanceSnapshot.src = croppedImageData;
    attendanceSnapshot.style.display = 'block';
    
    // Stop camera
    stopAttendanceCamera();
    
    // Submit attendance with cropped face
    submitAttendance(currentEmpId, croppedImageData);
}

function submitAttendance(empid, imageData) {
    if (isSubmitting) return;
    isSubmitting = true;
    
    const formData = new URLSearchParams();
    formData.append('employeeid', empid);
    formData.append('captured_image', imageData);
    
    attendanceFaceStatus.innerHTML = '‚è≥ Processing...';
    
    fetch('/take_attendance', { 
        method: 'POST', 
        body: formData,
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(async response => {
        const text = await response.text();
        
        if (!response.ok) {
            try {
                const data = JSON.parse(text);
                throw new Error(data.msg || `Server error: ${response.status}`);
            } catch (e) {
                throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`);
            }
        }
        
        try {
            return JSON.parse(text);
        } catch (e) {
            throw new Error('Invalid JSON response from server');
        }
    })
    .then(data => {
        if (data.status === 'ok') {
            attendanceResultBox.innerHTML = `
                <div class="alert alert-success">
                    <strong>‚úÖ ${data.message || 'Attendance recorded!'}</strong><br>
                    <small>${data.action === 'signed_in' ? 'Signed In' : 'Signed Out'}</small>
                </div>`;
            
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error(data.msg || 'Unknown error');
        }
    })
    .catch(err => {
        console.error('Submission error:', err);
        attendanceResultBox.innerHTML = `
            <div class="alert alert-danger">
                <strong>‚ùå Error:</strong> ${err.message}<br>
                <small>Please try again</small>
            </div>`;
        
        setTimeout(() => {
            isProcessing = false;
            hasCaptured = false;
            isSubmitting = false;
            attendanceEmpidInput.value = '';
            attendanceEmpidInput.focus();
            cameraStarted = false;
            consecutiveDetections = 0;
        }, 3000);
    });
}

// Cleanup
window.addEventListener('beforeunload', function() {
    if (attendanceStream) {
        attendanceStream.getTracks().forEach(track => track.stop());
    }
    if (detectionFrame) cancelAnimationFrame(detectionFrame);
});
</script>
{% endblock %}